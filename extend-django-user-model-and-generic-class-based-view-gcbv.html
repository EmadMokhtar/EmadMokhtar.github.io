<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/stylesheet/font-awesome.min.css">




    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

<meta name="author" content="Emad Mokhtar" />
<meta name="description" content="When I started to learn Django, I used to use the function based view aka FBV and in my current project I decided to learn class based view CBV, I watched one DjangoCon videos by Andrew Pinkham to make this easier on me, and if you tried or planning to ..." />
<meta name="keywords" content="Django, Python">
<meta property="og:site_name" content="Emad Mokhtar's Framework"/>
<meta property="og:title" content="Extend Django User Model and Generic Class Based View "GCBV""/>
<meta property="og:description" content="When I started to learn Django, I used to use the function based view aka FBV and in my current project I decided to learn class based view CBV, I watched one DjangoCon videos by Andrew Pinkham to make this easier on me, and if you tried or planning to ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/extend-django-user-model-and-generic-class-based-view-gcbv.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-12-18 12:00:00+03:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/emad-mokhtar.html">
<meta property="article:section" content="Django"/>
<meta property="article:tag" content="Django"/>
<meta property="article:tag" content="Python"/>
<meta property="og:image" content="/images/profile.jpg">
  <title>Emad Mokhtar's Framework &ndash; Extend Django User Model and Generic Class Based View "GCBV"</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/images/profile.jpg" alt="" title="">
      </a>
      <h1><a href=""></a></h1>
      <p>Geek developer who's in search of code perfection.</p>
      <nav>
        <ul class="list">
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="https://emadmokhtar.github.io/resume" target="_blank">Resume</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-envelope-o" href="mailto:emad@emadmokhtar.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-github" href="https://www.github.com/EmadMokhtar" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/373051/emad-mokhtar" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/emadmokhtarframework/" target="_blank"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/emadmokhtar" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/emadmokhtar/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="https://emadmokhtar.github.io/resume">Resume</a>
    </nav>

<article>
  <header>
    <h1 id="extend-django-user-model-and-generic-class-based-view-gcbv">Extend Django User Model and Generic Class Based View "GCBV"</h1>
    <p>Posted on Fri 18 December 2015 in <a href="/category/django.html">Django</a></p>
  </header>
  <div>
    <p><img alt="1450356512_full.png" src="/images/1450356512_full.png" /> When I started to learn Django, I used to use the function based view aka FBV and in my current project I decided to learn class based view CBV, I watched one <a href="https://www.youtube.com/watch?v=BJiOERA49ZQ">DjangoCon videos by Andrew Pinkham</a> to make this easier on me, and if you tried or planning to learn CBV, you will be confused about the class based views and the generic class based views inside Django, it’s some many of them, please watch the video to get your head around it. OK, now I’ve done my homework and it’s time to use CBV, believe me it’s easy and you will find the number of code lines inside our views will be decreased specially if you use GCBV. User Model and GCBV </p>
<h1>What is the relation between GCBV and User Model?</h1>
<p>Great question, while I’m working with one of my models fro example her the Teacher model, and teacher will has a user credentials in order to user the app. The easiest and the straightforward way is to make one-to-one relation with <a href="https://github.com/django/django/blob/53ccffdb8c8e47a4d4304df453d8c79a9be295ab/django/contrib/auth/models.py">django.contrib.auth.models.User</a> please read the quote from Django documentation: </p>
<blockquote>
<p>There are two ways to extend the default User model without substituting your own model. If the changes you need are purely behavioral, and don’t require any change to what is stored in the database, you can create a proxy model based on User. This allows for any of the features offered by proxy models including default ordering, custom managers, or custom model methods. If you wish to store information related to User, you can use a one-to-one relationship to a model containing the fields for additional information. This one-to-one model is often called a profile model, as it might store non-auth related information about a site user. </p>
</blockquote>
<p>So I decide to go with one-to-one relationship way. </p>
<h1>The Teacher Model</h1>
<div class="highlight"><pre><span></span>FEMALE = &#39;F&#39;
MALE = &#39;M&#39; 
class Teacher(models.Model): 
    GENDER_CHOICES = ( 
        (MALE, _(&#39;Male&#39;)), 
        (FEMALE, _(&#39;Female&#39;)), 
        ) 
    gender = models.CharField(max_length=1, verbose_name=_(&#39;Gender&#39;), choices=GENDER_CHOICES) 
    civil_id = models.CharField(max_length=12, verbose_name=_(&#39;Civil ID&#39;)) 
    phone_number = models.CharField(max_length=15, verbose_name=_(&#39;Phone Number&#39;)) 
    job_title = models.CharField(max_length=15, verbose_name=_(&#39;Title&#39;)) 
    user = models.OneToOneField(to=User, related_name=&#39;teacher_profile&#39;) 

    def enable(self): 
    &quot;&quot;&quot; 
    Enable teacher profile 
    :return: 
    &quot;&quot;&quot; 
    self.user.is_active = True 
    self.user.save() 

    def disable(self): 
    &quot;&quot;&quot; 
    Disable teacher profile 
    :return: 
    &quot;&quot;&quot; 
    self.user.is_active = False 
    self.user.save() 

    def get_absolute_url(self): 
        return reverse(&#39;teacher_details&#39;, args=(self.pk,))
</pre></div>


<h1>Issues</h1>
<p>The issue is I want to display all fields from Teacher and User form on one template page and handle the creation. so there are 2 issues: </p>
<ol>
<li>Display Teacher and User models fields’ on one template page using CreateView class.</li>
<li>Handle the under the hood creation process.
I posted a question over <a href="http://stackoverflow.com/questions/34117408/django-user-model-one-to-one-with-other-model-and-forms">Stack Overflow</a> regarding these issues. </li>
</ol>
<h1>Solutions</h1>
<h2>Thinking about a solution for the first issue</h2>
<p>After I studied the <em>CreateView</em> generic view class, it can take only one form using <em>form_class</em> attribute. I knew Django render context variables on the template, and <em>CreateView</em> will pass the <em>form_class</em> to the template to render it, so I thought about adding second form to the class and add it to the context before passing it to the template, thus I override <em>get_context_data()</em> method and add the second form to the context. </p>
<div class="highlight"><pre><span></span>def get_context_data(self, **kwargs): 
    #Get the context 
    context = super(TeacherCreation, self).get_context_data(**kwargs) 
    #Adding the second form 
    context[&#39;user_form&#39;] = self.second_form_class 
    return context 
</pre></div>


<p>Now I’m passing one form for Teacher model and the second form is for User model, and in the template display both forms. </p>
<div class="highlight"><pre><span></span><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span> <span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span> 
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;panel panel-default&quot;</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;panel-heading&quot;</span><span class="nt">&gt;</span> 
            <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">&quot;panel-title&quot;</span><span class="nt">&gt;</span> Teacher Information <span class="nt">&lt;/h3&gt;</span> 
            <span class="nt">&lt;/div&gt;</span> 
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;panel-body&quot;</span><span class="nt">&gt;</span> 
            <span class="cp">{{</span> <span class="nv">user_form</span> <span class="cp">}}</span> 
            <span class="cp">{{</span> <span class="nv">form</span> <span class="cp">}}</span> 
            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span> 
</pre></div>


<p>The first issue solved. </p>
<h2>Thinking for a solution for the second issue</h2>
<p>Now I can display 2 forms on template using <em>CreateView</em> class, but what about posting or saving data/form. To do this I override <em>form_valid</em> method and done the work there. </p>
<div class="highlight"><pre><span></span>def form_valid(self, form): 
    user_form = UserCreationForm(self.request.POST) 
    if user_form.is_valid(): 
        user = user_form.save() 
        teacher = form.save(commit=False) 
        teacher.user_id = user.id 
        teacher.save() 
        return HttpResponseRedirect(self.get_success_url())
</pre></div>


<p>The second issue solved but what about the update, it's easy and almost the same as <em>CreateView</em>, so let's see How er can do it </p>
<div class="highlight"><pre><span></span>def get_context_data(self, **kwargs): 
    context = super(TeacherUpdate, self).get_context_data(**kwargs) 
    context[&#39;user_form&#39;] = self.second_form_class(self.request.POST or None, instance=self.object.user) 
    return context 

def form_valid(self, form): 
    user_form = UserChangeForm(self.request.POST, instance=self.object.user) 
    if user_form.is_valid(): 
        user_form.save() 
        return super(TeacherUpdate, self).form_valid(form)
</pre></div>


<h1>Full Example</h1>
<div class="highlight"><pre><span></span><span class="x">########################</span>
<span class="x"># models.py</span>
<span class="x">########################</span>
<span class="x">FEMALE = &#39;F&#39;</span>
<span class="x">MALE = &#39;M&#39;</span>

<span class="x">class Teacher(models.Model):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    Halaqat teachers information</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    GENDER_CHOICES = (</span>
<span class="x">        (MALE, _(&#39;Male&#39;)),</span>
<span class="x">        (FEMALE, _(&#39;Female&#39;)),</span>
<span class="x">    )</span>
<span class="x">    gender = models.CharField(max_length=1, verbose_name=_(&#39;Gender&#39;),</span>
<span class="x">                              choices=GENDER_CHOICES)</span>
<span class="x">    civil_id = models.CharField(max_length=12, verbose_name=_(&#39;Civil ID&#39;))</span>
<span class="x">    phone_number = models.CharField(max_length=15,</span>
<span class="x">                                    verbose_name=_(&#39;Phone Number&#39;))</span>
<span class="x">    job_title = models.CharField(max_length=15, verbose_name=_(&#39;Title&#39;))</span>
<span class="x">    user = models.OneToOneField(to=User, related_name=&#39;teacher_profile&#39;)</span>

<span class="x">    def enable(self):</span>
<span class="x">        &quot;&quot;&quot;</span>
<span class="x">        Enable teacher profile</span>
<span class="x">        :return:</span>
<span class="x">        &quot;&quot;&quot;</span>
<span class="x">        self.user.is_active = True</span>
<span class="x">        self.user.save()</span>

<span class="x">    def disable(self):</span>
<span class="x">        &quot;&quot;&quot;</span>
<span class="x">        Disable teacher profile</span>
<span class="x">        :return:</span>
<span class="x">        &quot;&quot;&quot;</span>
<span class="x">        self.user.is_active = False</span>
<span class="x">        self.user.save()</span>

<span class="x">    def get_absolute_url(self):</span>
<span class="x">        return reverse(&#39;teacher_details&#39;, args=(self.pk,))</span>

<span class="x">########################</span>
<span class="x"># views.py</span>
<span class="x">########################</span>
<span class="x">class TeacherCreation(SuccessMessageMixin, CreateView):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    Creates new teacher</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    template_name = &#39;back_office/teacher_form.html&#39;</span>
<span class="x">    form_class = TeacherForm</span>
<span class="x">    model = Teacher</span>
<span class="x">    second_form_class = UserCreationForm</span>
<span class="x">    success_message = &#39;Teacher profile saved successfully&#39;</span>

<span class="x">    def get_context_data(self, **kwargs):</span>
<span class="x">        context = super(TeacherCreation, self).get_context_data(**kwargs)</span>

<span class="x">        context[&#39;user_form&#39;] = self.second_form_class</span>

<span class="x">        return context</span>

<span class="x">    def form_valid(self, form):</span>
<span class="x">        user_form = UserCreationForm(self.request.POST)</span>
<span class="x">        if user_form.is_valid():</span>
<span class="x">            user = user_form.save()</span>
<span class="x">            teacher = form.save(commit=False)</span>
<span class="x">            teacher.user_id = user.id</span>
<span class="x">            teacher.save()</span>
<span class="x">        return HttpResponseRedirect(self.get_success_url())</span>

<span class="x">class TeacherUpdate(SuccessMessageMixin, UpdateView):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    Update teacher profile</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    model = Teacher</span>
<span class="x">    template_name = &#39;back_office/teacher_form.html&#39;</span>
<span class="x">    form_class = TeacherForm</span>
<span class="x">    second_form_class = UserChangeForm</span>
<span class="x">    success_message = &#39;Teacher profile saved successfully&#39;</span>

<span class="x">    def get_context_data(self, **kwargs):</span>
<span class="x">        context = super(TeacherUpdate, self).get_context_data(**kwargs)</span>

<span class="x">        context[&#39;user_form&#39;] = self.second_form_class(self.request.POST or None, instance=self.object.user)</span>

<span class="x">        return context</span>

<span class="x">    def form_valid(self, form):</span>
<span class="x">        user_form = UserChangeForm(self.request.POST, instance=self.object.user)</span>
<span class="x">        if user_form.is_valid():</span>
<span class="x">            user_form.save()</span>
<span class="x">        return super(TeacherUpdate, self).form_valid(form)</span>

<span class="x">########################</span>
<span class="x"># teacher_form.html</span>
<span class="x">########################</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;back_office/back_office_base.html&#39;</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">crispy_forms_tags</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    New Teacher Form</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">container</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;form method=&quot;post&quot;&gt;</span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;div class=&quot;panel panel-default&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;panel-heading&quot;&gt;</span>
<span class="x">                &lt;h3 class=&quot;panel-title&quot;&gt;Teacher Information&lt;/h3&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">            &lt;div class=&quot;panel-body&quot;&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">user_form</span><span class="o">|</span><span class="nf">crispy</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">form</span><span class="o">|</span><span class="nf">crispy</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">                &lt;button class=&quot;btn btn-primary&quot; type=&quot;submit&quot;&gt;</span>
<span class="x">                    &lt;span class=&quot;glyphicon glyphicon-floppy-disk&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span>
<span class="x">                            Save</span>
<span class="x">                &lt;/button&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/django.html">Django</a>
      <a href="/tag/python.html">Python</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'emadmokhtarsframework';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
        <p>&copy; Emad Mokhtar </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Extend Django User Model and Generic Class Based View "GCBV"",
  "headline": "Extend Django User Model and Generic Class Based View "GCBV"",
  "datePublished": "2015-12-18 12:00:00+03:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Emad Mokhtar",
    "url": "/author/emad-mokhtar.html"
  },
  "image": "/images/profile.jpg",
  "url": "/extend-django-user-model-and-generic-class-based-view-gcbv.html",
  "description": "When I started to learn Django, I used to use the function based view aka FBV and in my current project I decided to learn class based view CBV, I watched one DjangoCon videos by Andrew Pinkham to make this easier on me, and if you tried or planning to ..."
}
</script></body>
</html>